<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WAVE CARD</title>
    <link rel="stylesheet" th:href="@{/css/member/card/view.css}">
</head>
<body>
<div th:replace="~{common/header :: header}"></div>

<main>
    <div class="main-container">
        <div id="main-content">
            <div class="detail-wrap">

                <section class="card-top">
                    <div class="card-top-left">
                        <div class="card-preview">
                            <img th:src="@{${cardItem.card.background != null ? '/' + cardItem.card.background : '/' + cardItem.card.thumbnail}}"
                                 th:alt="${cardItem.card.name}">
                        </div>
                    </div>

                    <div class="card-top-right">
                        <div class="top-head">
                            <h1 class="card-title">
                                [[${cardItem.card.name}]]<br>
                                [[${cardItem.card.engName}]]
                            </h1>
                        </div>
                        <p class="card-sub" th:text="${cardItem.card.description}"></p>

                        <div class="top-benefits">
                            <p th:each="b, stat : ${cardItem.benefitList}" th:if="${stat.index < 4}">
                                <span>[[${b.benefitCategory}]]</span>
                                <strong>[[${b.value}]] [[${b.unit}]] [[${b.benefitType}]]</strong>
                            </p>
                        </div>
                    </div>
                </section>

                <div class="annual-box">
                    <div class="annual-top">
                        <span class="annual-title">연회비</span>
                        <a href="javascript:void(0)" class="annual-arrow" id="openFee">›</a>
                    </div>
                    <ul class="annual-rows">
                        <li th:each="fee : ${cardItem.annualFeeList}" th:if="${fee != null and fee.annualName != null}">
                            <span class="annual-type">
                                <span th:if="${#strings.contains(fee.annualName, '국내전용')}"> </span>
                                <span th:if="${#strings.contains(fee.annualName, '국내외겸용')}">  </span>
                                [[${fee.annualName}]]
                            </span>
                        </li>
                    </ul>
                </div>

                <section class="card-notice">
                    <header class="card-notice-head" id="cardNoticeToggle">
                        <h3>카드발급 유의사항</h3>
                        <button type="button" class="card-notice-btn" aria-expanded="false">
                            <span class="tri"></span>
                        </button>
                    </header>
                    <div class="card-notice-body" id="cardNoticeBody">
                        <ul>
                            <li>연회비는 기본연회비와 서비스연회비를 합산해 카드별로 청구됩니다.</li>
                            <li>가족카드 연회비는 없습니다. (가족카드 단독 발급 시 연회비가 부과될 수 있습니다.)</li>
                            <li>후불교통 기능이 있는 카드로만 신청 가능합니다.</li>
                            <li>해외겸용(Mastercard)은 컨택리스 결제를 지원합니다.</li>
                        </ul>
                    </div>
                </section>

                <section class="benefit-section">
                    <div class="benefit-grid" th:each="ben : ${cardItem.benefitList}">
                        <article class="benefit-card">
                            <h4>[[${ben.benefitCategory}]]</h4>
                            <ul>
                                <li>[[${ben.benefitDescription}]]</li>
                            </ul>
                            <span class="card-more">›</span>
                        </article>
                    </div>
                </section>

                <section class="card-compare-wrap">
                    <div class="compare-title">
                        <h2>이 카드랑 비교해 보세요.</h2>
                        <p>비교할 카드를 선택하면 오른쪽에 표시됩니다.</p>
                    </div>

                    <div class="compare-body">
                        <div class="compare-card current-card" id="currentCard">
                            <p class="label">현재 보고 있는 카드</p>
                            <div class="card-box">
                                <div class="card-thumb">
                                    <img th:src="@{${cardItem.card.background != null ? '/' + cardItem.card.background : '/' + cardItem.card.thumbnail}}"
                                         th:alt="${cardItem.card.name}" class="card-img">
                                </div>
                                <div class="card-info">
                                    <h3 class="card-name">[[${cardItem.card.name}]]</h3>
                                    <p class="card-benefit">
                                        <span th:each="ben, stat : ${cardItem.benefitList}">
                                            [[${ben.benefitCategory}]]
                                            <span th:unless="${stat.last}">, </span>
                                        </span>
                                    </p>
                                </div>
                            </div>
                            <span id="currentCardBenefitsData" style="display: none;" th:data-benefits-str="${cardItem.categoryString}"></span>
                        </div>

                        <div class="compare-plus">+</div>

                        <div class="compare-card target-card" id="targetCard">
                            <p class="label">비교할 카드 선택</p>
                            <button class="card-box empty" id="openModalBtn" type="button">
                                아래에서 카드를 선택해주세요.
                            </button>
                        </div>
                    </div>

                    <section class="benefit-compare" id="benefitCompare" style="display: none;">
                        <div class="benefit-compare-grid">
                            <div class="benefit-column" id="currentBenefits">
                                <h4>현재 카드</h4>
                                <ul class="benefit-list">
                                    <li class="placeholder" th:each="ben : ${cardItem.benefitList}">
                                        [[${ben.benefitCategory}]]: [[${ben.benefitDescription}]]
                                    </li>
                                </ul>
                            </div>
                            <div class="benefit-column" id="targetBenefits">
                                <h4>비교할 카드</h4>
                                <ul class="benefit-list">
                                    <li class="placeholder">오른쪽 카드 선택 시 표시됩니다.</li>
                                </ul>
                            </div>
                        </div>
                    </section>
                </section>

                <section class="card-notice" id="extraService">
                    <header class="card-notice-head">
                        <h3>부가서비스 변경 가능 사유</h3>
                        <button type="button" class="card-notice-btn" aria-expanded="false">
                            <span class="tri"></span>
                        </button>
                    </header>
                    <div class="card-notice-body">
                        <p class="notice-text">* 카드 제공 부가서비스 변경 관련 안내...</p>
                        <ol class="notice-list">
                            <li>① 카드사의 휴업·파산·경영상의 위기 등에 따른 불가피한 경우 : 사유발생 즉시</li>
                            <li>② 제휴업체의 휴업·파산·경영상의 위기로 인해 불가피하게 해당 부가서비스를 축소·변경하는 경우 : 사유발생 즉시</li>
                            <li>③ 제휴업체와의 계약 해지로 인해 동일한 부가서비스 제공이 곤란한 경우 : 사유발생 즉시</li>
                            <li>④ 부가서비스를 3년 이상 제공한 상태에서 상품 수익성이 낮아진 경우 : 변경 6개월 전부터 매월</li>
                        </ol>
                    </div>
                </section>

                <section class="must-guide">
                    <h3>필수 안내 사항</h3>
                    <ul>
                        <li>연체이자율 : 회원별·이용상품별 정상이자율 + 3%p (최고 연 20.0%)</li>
                        <li>금융상품 이용 전 상품설명서, 약관 확인</li>
                        <li>신용카드 남용은 가계경제에 위험</li>
                    </ul>
                </section>

                <div class="floating-apply">
                    <form th:action="@{/card/register1}" method="get">
                        <input type="hidden" name="cardId" th:value="${cardItem.card.cardId}">
                        <button type="submit" class="btn-main">카드신청</button>
                    </form>
                    <button type="button" class="btn-sub">뒤로가기</button>
                </div>

            </div>
        </div>
    </div>
</main>

<div class="fee-modal" id="feeModal">
    <div class="fee-modal-dim" id="feeDim"></div>
    <div class="fee-modal-box">
        <div class="fee-modal-header">
            <h2>연회비</h2>
            <button type="button" class="fee-modal-close" id="feeClose">✕</button>
        </div>
        <div class="fee-modal-body" th:each="fee, iterStat : ${cardItem.annualFeeList}">
            <div class="fee-item" th:if="${fee != null}">
                <h3 class="fee-title">
                    <span th:if="${iterStat.count == 1}"> </span>
                    <span th:if="${iterStat.count == 2}"> </span>
                    [[${fee.annualName}]]
                </h3>
                <div class="fee-line"></div>
            </div>
        </div>
        <ul class="fee-notice">
            <li>카드 연회비(기본연회비 + 제휴연회비)는 카드 발급 시 선청구되며, 보유 카드별로 청구됨</li>
            <li>기본연회비는 카드 발행, 배송 등 발급에 소요된 비용으로, 발급 첫 해에 해지해도 반환되지 않음</li>
        </ul>
    </div>
</div>

<div class="card-modal-overlay" id="cardModal">
    <div class="card-modal">
        <div class="card-modal-header">
            <h3>비교할 카드 선택</h3>
            <button class="close-modal" id="closeModalBtn" type="button">×</button>
        </div>
        <div class="card-modal-body">
            <button class="modal-card-item"
                    th:each="compareCard : ${compareCards}"
                    th:data-card-name="${compareCard.card.name}"
                    th:data-card-benefit="${compareCard.categoryString}"
                    th:data-card-img="@{${compareCard.card.background != null ? '/' + compareCard.card.background : '/' + compareCard.card.thumbnail}}">
                <div class="modal-card-thumb">
                    <img th:src="@{${compareCard.card.background != null ? '/' + compareCard.card.background : '/' + compareCard.card.thumbnail}}"
                         th:alt="${compareCard.card.name}"/>
                </div>
                <div class="modal-card-info">
                    <span class="modal-card-name" th:text="${compareCard.card.name}">삼성카드 탭탭 O</span>
                    <span class="modal-card-benefit" th:text="${compareCard.categoryString}">커피/스트리밍 특화</span>
                </div>
                <div style="display: none;" class="benefit-details">
                    <span th:each="ben : ${compareCard.benefitList}"
                          th:data-category="${ben.benefitCategory}"
                          th:data-desc="${ben.benefitDescription}"></span>
                </div>
            </button>
        </div>
    </div>
</div>

<div th:replace="~{common/footer :: footer}"></div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        fetch('../common/header.html')
            .then(res => res.text())
            .then(html => document.getElementById('header').innerHTML = html);

        fetch('../common/footer.html')
            .then(res => res.text())
            .then(html => document.getElementById('footer').innerHTML = html);
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const openBtn = document.getElementById('openFee');
        const modal = document.getElementById('feeModal');
        const dim = document.getElementById('feeDim');
        const closeBtn = document.getElementById('feeClose');

        if (openBtn) openBtn.addEventListener('click', () => modal.classList.add('show'));
        [dim, closeBtn].forEach(el => el.addEventListener('click', () => modal.classList.remove('show')));
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const noticeSections = document.querySelectorAll('.card-notice');
        noticeSections.forEach(section => {
            const head = section.querySelector('.card-notice-head');
            const body = section.querySelector('.card-notice-body');
            const btn = section.querySelector('.card-notice-btn');

            head.addEventListener('click', function () {
                const opened = body.style.maxHeight && body.style.maxHeight !== '0px';
                if (opened) {
                    body.style.maxHeight = '0px';
                    btn.classList.remove('active');
                    btn.setAttribute('aria-expanded', 'false');
                } else {
                    body.style.maxHeight = body.scrollHeight + 'px';
                    btn.classList.add('active');
                    btn.setAttribute('aria-expanded', 'true');
                }
            });
        });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('cardModal');
        const openBtn = document.getElementById('openModalBtn');
        const closeBtn = document.getElementById('closeModalBtn');
        const targetBox = document.querySelector('#targetCard .card-box');
        const targetBenefitsUl = document.querySelector('#targetBenefits .benefit-list');
        const benefitCompareSec = document.getElementById('benefitCompare');

        function renderCardBox(boxEl, data) {
            const {img, name, benefit} = data;
            const thumbHtml = img
                ? `<div class="card-thumb"><img src="${img}" alt="${name || ''}" class="card-img"></div>`
                : `<div class="card-thumb card-thumb-text">${(name || 'C').charAt(0)}</div>`;
            boxEl.classList.remove('empty');
            boxEl.innerHTML = `${thumbHtml}<div class="card-info">${name ? `<h3 class="card-name">${name}</h3>` : ''}${benefit ? `<p class="card-benefit">${benefit}</p>` : ''}</div>`;
        }

        if (openBtn) openBtn.addEventListener('click', () => modal.style.display = 'flex');
        if (closeBtn) closeBtn.addEventListener('click', () => modal.style.display = 'none');

        if (modal) {
            modal.addEventListener('click', function (e) {
                if (e.target === modal) return modal.style.display = 'none';
                const item = e.target.closest('.modal-card-item');
                if (!item) return;

                const name = item.dataset.cardName;
                const benefit = item.dataset.cardBenefit;
                const img = item.dataset.cardImg;
                renderCardBox(targetBox, {img, name, benefit});

                const benefitSpans = item.querySelectorAll('.benefit-details span');
                targetBenefitsUl.innerHTML = '';
                if (benefitSpans.length > 0) {
                    benefitSpans.forEach(span => {
                        const li = document.createElement('li');
                        li.textContent = `${span.dataset.category}: ${span.dataset.desc}`;
                        targetBenefitsUl.appendChild(li);
                    });
                } else {
                    targetBenefitsUl.innerHTML = '<li class="placeholder">혜택 정보가 없습니다.</li>';
                }

                if (benefitCompareSec) benefitCompareSec.style.display = 'block';
                modal.style.display = 'none';
            });
        }
    });
</script>

</body>
</html>
