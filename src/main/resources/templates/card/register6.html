<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>영문명 및 해외결제 설정</title>

    <link rel="stylesheet" href="../css/common/product_header_style.css" />
    <link rel="stylesheet" href="../../static/css/member/card/register6.css" />
    <link rel="stylesheet" href="../css/common/footer_style.css" />
</head>

<body>
<div th:replace="~{common/product_header :: product_header}"></div>

<main class="content">
    <form id="step6Form" th:action="@{/card/apply/step6}" method="post">
        <input type="hidden" name="cardId" th:value="${cardItem.card.cardId}" />
        <input type="hidden" id="postpaidTransit" name="postpaidTransit" value="" />
        <input type="hidden" id="overseasUse" name="overseasUse" value="" />

        <section class="en-wrap">
            <div class="apply-progress"
                 data-total="9"
                 data-step="5">
            </div>
            <p class="page-guide">여권의 영문 이름과 다르다면 수정해 주세요.</p>

            <div class="row-2">
                <div class="form-item">
                    <label for="enLast">영문 성</label>
                    <input id="enLast" name="lastNameEn" type="text" placeholder="KIM"
                           th:value="${applyInfo.lastNameEn}" />
                </div>
                <div class="form-item">
                    <label for="enFirst">영문이름</label>
                    <input id="enFirst" name="firstNameEn" type="text" placeholder="CHEOLSU"
                           th:value="${applyInfo.firstNameEn}" />
                </div>
            </div>

            <button type="button" class="line-btn" id="transitToggle">
                <span>후불교통 기능 신청</span>
                <span class="switch" aria-hidden="true"><i></i></span>
            </button>

            <div class="section-head">
                <h3>해외 결제 여부</h3>
            </div>

            <div class="card-choices" id="overseasGroup">
                <button type="button" class="choice" data-value="dual">
                    <span class="logo visa" aria-hidden="true">VISA</span>
                    <span class="label">국내외겸용</span>
                    <span class="check">✔</span>
                </button>

                <button type="button" class="choice" data-value="domestic">
                    <span class="logo local" aria-hidden="true"></span>
                    <span class="label">국내전용</span>
                    <span class="check">✔</span>
                </button>
            </div>

            <ul class="notice">
                <li>국내외겸용 및 국내전용카드 연회비 동일</li>
                <li>국내외겸용(VISA)은 우리은행·신한은행 계좌만 결제 계좌로 등록할 수 있습니다.</li>
            </ul>

            <button type="submit" id="btnSubmit" class="btn-submit" disabled>확인</button>
        </section>
    </form>
</main>

<div th:replace="~{common/footer :: footer}"></div>

<script th:inline="javascript">
    // ----------------------------------------------------------------------
    // [필수] 서버 DTO 값을 JavaScript 변수로 가져와 UI 초기화에 사용
    // ----------------------------------------------------------------------
    const initialApplyInfo = [[${applyInfo}]];
    const initialPostpaidTransit = initialApplyInfo ? initialApplyInfo.postpaidTransit : 'N';
    const initialOverseasUse = initialApplyInfo ? initialApplyInfo.overseasUse : '';
    // ----------------------------------------------------------------------


    // ===== 페이지 로직 =====
    document.addEventListener('DOMContentLoaded', () => {
        const enLast = document.getElementById('enLast');
        const enFirst = document.getElementById('enFirst');
        const toggle = document.getElementById('transitToggle');
        const group = document.getElementById('overseasGroup');
        const submit = document.getElementById('btnSubmit');

        // Hidden 필드 참조 (폼 제출 시 서버로 전송됨)
        const postpaidTransitInput = document.getElementById('postpaidTransit');
        const overseasUseInput = document.getElementById('overseasUse');

        // [초기화]: 해외 결제 선택 여부 변수를 DTO 초기값으로 설정
        let selected = initialOverseasUse;

        // --------------------------------------------------------
        // 1. 초기 상태 설정 (서버 DTO 값 반영)
        // --------------------------------------------------------

        // 1-1. 후불교통 초기화 (Hidden Input & UI)
        postpaidTransitInput.value = initialPostpaidTransit;
        if (initialPostpaidTransit === 'Y') {
            toggle.classList.add('on');
        }

        // 1-2. 해외 결제 초기화 (Hidden Input & UI)
        overseasUseInput.value = initialOverseasUse;
        if (initialOverseasUse) {
            // 초기값에 맞는 버튼에 'active' 클래스 부여
            const initialBtn = document.querySelector(`.choice[data-value="${initialOverseasUse}"]`);
            if (initialBtn) {
                initialBtn.classList.add('active');
            }
        }

        // --------------------------------------------------------

        // 2) 영문명 입력: 자동 대문자 변환
        [enLast, enFirst].forEach(inp => {
            inp.addEventListener('input', () => {
                // 입력 필드 값 자동 대문자 변환 및 유효성 체크
                inp.value = inp.value.toUpperCase().replace(/[^A-Z\s\-]/g, '');
                refresh();
            });
        });

        // 3) 후불교통 토글: Hidden Input 값 업데이트 (Y/N)
        toggle.addEventListener('click', () => {
            const isActive = toggle.classList.toggle('on');
            postpaidTransitInput.value = isActive ? 'Y' : 'N';
            refresh();
        });

        // 4) 해외결제 카드 옵션 선택: Hidden Input 값 업데이트 ('dual' / 'domestic')
        group.addEventListener('click', (e) => {
            const btn = e.target.closest('.choice');
            if (!btn) return;

            // UI 상태 변경
            group.querySelectorAll('.choice').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');

            // Hidden Input 및 로컬 변수 업데이트
            selected = btn.dataset.value;
            overseasUseInput.value = selected;

            refresh();
        });

        // 5) 버튼 활성화 조건 (유효성 검사)
        function refresh() {
            // 영문명 필드 유효성 검사 (th:value로 채워진 값이 있어도 trim() 후 길이를 확인)
            const okNames = enLast.value.trim().length > 0 && enFirst.value.trim().length > 0;

            // 해외 결제 옵션이 선택되어 유효한 값('dual' 또는 'domestic')을 가졌는지 검사
            const okOverseas = selected !== null && selected.trim().length > 0;

            submit.disabled = !(okNames && okOverseas);
        }
        refresh();

        // **제출 로직 제거:** 버튼의 type="submit" 속성으로 인해 폼은 자동으로 POST /card/apply/step6로 전송됩니다.
        // 추가적인 eventListener가 필요 없습니다.

        const progress = document.querySelector('.apply-progress');
        if (!progress) return;

        const total  = Number(progress.dataset.total || 9); // 기본 10단계
        const step   = Number(progress.dataset.step  || 1);  // 현재 단계

        // 바 래퍼 생성
        const bar = document.createElement('div');
        bar.className = 'apply-progress-bar';

        // 칸 만들기
        for (let i = 1; i <= total; i++) {
            const span = document.createElement('span');
            span.className = 'progress-step';
            if (i <= step) {
                span.classList.add('is-active'); // 현재 단계까지 색 칠하기
            }
            bar.appendChild(span);
        }

        progress.appendChild(bar);
    });
</script>

</body>

</html>
