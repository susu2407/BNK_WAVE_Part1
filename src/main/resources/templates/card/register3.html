<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" th:href="@{/css/member/card/register3.css}">
</head>
<body>
<div th:replace="~{common/product_header :: product_header}"></div>
<main>
    <div class="main-container">
        <div id="main-content">
            <section class="verify-wrap">
                <div class="apply-progress"
                     data-total="9"
                     data-step="2">
                </div>
                <h1 class="verify-title"><strong>사용자</strong> 님, 본인인증을 진행해 주세요.</h1>

                <!-- 인증수단 탭 -->
                <div class="method-tabs">
                    <button class="tab on">휴대폰</button>
                </div>

                <div class="divider"></div>

                <!-- 약관 -->
                <section class="terms">
                    <button type="button" class="terms-head" id="termsToggle">
                    <span class="left">
                        <span class="bullet">✓</span>
                        (필수)휴대폰 인증 약관 동의
                    </span>
                        <span class="chev">›</span>
                    </button>
                    <div class="terms-body" id="termsBody">
                        <ul>
                            <li>개인정보 수집 및 이용 동의</li>
                            <li>고유식별정보 처리 동의</li>
                            <li>통신사 이용약관 동의</li>
                            <li>서비스 이용약관 동의</li>
                        </ul>
                    </div>
                </section>

                <!-- 휴대폰 번호 -->
                <div class="form-item phone-line">
                    <label for="phone">휴대폰번호</label>
                    <div class="inline-field">
                        <input id="phone" type="text" inputmode="numeric" maxlength="11" placeholder="숫자만 입력해 주세요.">
                        <button type="button" class="btn-ghost" id="reqBtn">재요청</button>
                    </div>
                    <div class="underline"></div>
                </div>

                <!-- 인증번호 -->
                <div class="form-item code-line">
                    <label for="code">인증번호 6자리</label>
                    <div class="inline-field">
                        <input id="code" type="text" inputmode="numeric" maxlength="6" placeholder="">
                        <span class="timer" id="timer">02:58</span>
                    </div>
                    <div class="underline"></div>
                </div>

                <!-- 안내 -->
                <ul class="notes">
                    <li>인증번호를 발송했습니다.(유효 시간 3분)</li>
                    <li>인증번호가 오지 않는 경우 입력한 정보가 정확한지 확인해 주세요.</li>
                    <li><u>본인 인증에 사용한 휴대폰 번호로 회원정보가 자동 변경 · 저장됩니다.</u></li>
                </ul>

                <form id="verifyForm" th:action="@{/card/register5}" method="get">
                    <input type="hidden" name="cardId" th:value="${cardItem.card.cardId}">

                    <button class="btn-submit" id="submitBtn" disabled>확인</button>
                </form>
            </section>
        </div>
    </div>
</main>
<div th:replace="~{common/footer :: footer}"></div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // 1. 요소 변수 선언
        const verifyForm = document.getElementById('verifyForm'); // 폼 ID는 'verifyForm'으로 가정
        const phoneInput = document.getElementById('phone');
        const codeInput = document.getElementById('code');
        const submitBtn = document.getElementById('submitBtn');
        const reqBtn = document.getElementById('reqBtn');
        const timerEl = document.getElementById('timer');
        const notesList = document.querySelector('.notes');

        const head = document.getElementById('termsToggle');
        const bullet = head ? head.querySelector('.bullet') : null;
        const body = document.getElementById('termsBody');
        const left = head ? head.querySelector('.left') : null;
        const chev = head ? head.querySelector('.chev') : null;

        let timer;
        let timeLeft = 0;
        let correctCode = ''; // 정답 인증번호를 저장할 변수

        // --- 2. 헤더/푸터 로드 (오류 발생 시 이 부분은 제거해도 무방) ---
        // th:replace를 사용하고 있으므로, 이 클라이언트 측 로드는 제거합니다.
        /*
        fetch('../common/product_header.html').then(r => r.text()).then(h => {
            document.getElementById('header').innerHTML = h;
        });
        fetch('../common/footer.html').then(r => r.text()).then(h => {
            document.getElementById('footer').innerHTML = h;
        });
        */

        // --- 3. 타이머 관련 함수 ---
        function startTimer() {
            clearInterval(timer);
            timeLeft = 180; // 3분

            timer = setInterval(() => {
                const m = String(Math.floor(timeLeft / 60)).padStart(2, '0');
                const s = String(timeLeft % 60).padStart(2, '0');
                timerEl.textContent = `${m}:${s}`;

                if (timeLeft-- <= 0) {
                    clearInterval(timer);
                    timerEl.textContent = "00:00";
                    alert("인증 시간이 만료되었습니다. 인증번호를 다시 요청해 주세요.");
                }
                refreshSubmit();
            }, 1000);
        }

        // --- 4. 버튼 활성화 갱신 ---
        function refreshSubmit() {
            const termsChecked = bullet ? bullet.classList.contains('on') : false;
            const codeOk = codeInput.value.replace(/\D/g, '').length === 6;
            const timeOk = timeLeft > 0;

            submitBtn.disabled = !(termsChecked && codeOk && timeOk);
        }

        // --- 5. 인증번호 요청/재요청 로직 ---
        if (reqBtn) {
            // 초기 텍스트 설정
                reqBtn.textContent = "인증요청";
                timerEl.textContent = "03:00";


            reqBtn.addEventListener('click', () => {
                const phoneValue = phoneInput.value.replace(/\D/g, '');
                if (phoneValue.length !== 11) {
                    alert("휴대폰 번호 11자리를 정확히 입력해주세요.");
                    return;
                }

                // 랜덤 인증번호 생성
                correctCode = String(Math.floor(Math.random() * 900000 + 100000));
                console.log(`[인증번호] ${phoneValue}로 전송된 코드: ${correctCode}`);



                // 타이머 시작/리셋
                startTimer();
                reqBtn.textContent = "재요청";

                // 3초 딜레이 후 자동 입력
                setTimeout(() => {
                    codeInput.value = correctCode;
                    refreshSubmit();
                    console.log("3초 후 인증번호 자동 입력 완료.");
                }, 3000);
            });
        }

        // --- 6. 입력 값 제한 및 탭 로직 ---
        // 탭
        document.querySelectorAll('.method-tabs .tab').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.method-tabs .tab').forEach(b => b.classList.remove('on'));
                btn.classList.add('on');
            });
        });

        // 휴대폰
        if (phoneInput) {
            phoneInput.addEventListener('input', function () {
                let v = this.value.replace(/\D/g, '').slice(0, 11);
                this.value = v;
            });
        }

        // 인증번호
        if (codeInput) {
            codeInput.addEventListener('input', function () {
                let v = this.value.replace(/\D/g, '').slice(0, 6);
                this.value = v;
                refreshSubmit();
            });
        }

        // --- 7. 약관 및 버튼 활성화 로직 ---
        if (head) {
            // 약관 체크 (왼쪽 텍스트)
            if (left) {
                left.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const on = bullet.classList.toggle('on');
                    head.setAttribute('aria-checked', on ? 'true' : 'false');
                    refreshSubmit();
                });
            }

            // 약관 열기/닫기 (화살표)
            if (chev && body) {
                chev.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const opened = body.style.maxHeight;
                    if (opened) {
                        body.style.maxHeight = null;
                        head.classList.remove('open');
                    } else {
                        body.style.maxHeight = body.scrollHeight + 'px';
                        head.classList.add('open');
                    }
                });
            }

            head.setAttribute('role', 'switch');
            head.setAttribute('aria-checked', 'false');
        }

        // --- 8. 최종 확인 (submitBtn) 로직 ---
        if (verifyForm) {
            verifyForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const submittedCode = codeInput.value;

                if (submittedCode === correctCode && timeLeft > 0) {
                    alert("본인 인증에 성공했습니다. 다음 단계로 이동합니다.");
                    verifyForm.submit(); // 폼 제출로 다음 단계 이동
                } else if (timeLeft <= 0) {
                    alert("인증 시간이 만료되었습니다. 재요청해 주세요.");
                } else {
                    alert("인증번호가 일치하지 않습니다.");
                }
            });
        }

        // --- 9. 초기 상태 ---
        refreshSubmit();

        const progress = document.querySelector('.apply-progress');
        if (!progress) return;

        const total  = Number(progress.dataset.total || 9); // 기본 10단계
        const step   = Number(progress.dataset.step  || 1);  // 현재 단계

        // 바 래퍼 생성
        const bar = document.createElement('div');
        bar.className = 'apply-progress-bar';

        // 칸 만들기
        for (let i = 1; i <= total; i++) {
            const span = document.createElement('span');
            span.className = 'progress-step';
            if (i <= step) {
                span.classList.add('is-active'); // 현재 단계까지 색 칠하기
            }
            bar.appendChild(span);
        }

        progress.appendChild(bar);
    });
</script>
</body>
</html>