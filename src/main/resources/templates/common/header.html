<header class="header">
    <link rel="stylesheet" th:href="@{/css/common/header.css}">
    <div class="header-inner">
        <div class="logo">
            <div class="logo-main">
                <a th:href="@{/}">
                    <img src="https://www.busanbank.co.kr/resource/img/tit/h1_busanbank_new.png" alt="">
                </a>
            </div>
        </div>

        <!-- 1차 메뉴: hover하면 아래 .mega-panel이 열리는 구조 -->
        <ul class="nav_menu">
            <li title="menu1">
                <a th:href="@{/my}" class="menu_title">마이</a>
                <!-- 임시 메뉴 하위 영역 -->
                <div class="mega-panel">
                    <div class="mega-inner">
                        <div class="mega-col">
                            <h4>카드 이용 내역</h4>
                            <ul>
                                <li><a th:href="@{/my/OwnCard}">보유 금융 상품</a></li>
                                <li><a th:href="@{/my/CardHistory}">이용내역 명세서</a></li>
                                <li><a th:href="@{/my/RecentHistory}">최근 이용 내역</a></li>
                                <li><a href="#">결제 위치 지도로 확인하기</a></li>
                            </ul>
                        </div>
                        <div class="mega-col">
                            <h4>이용 금액 결제</h4>
                            <ul>
                                <li><a href="#">즉시 납부</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </li>

            <li title="menu2">
                <a th:href="@{/my}" class="menu_title">혜택</a>
                <div class="mega-panel">
                    <div class="mega-inner">
                    </div>
                </div>
            </li>

            <li>
                <a th:href="@{/card/list}" class="menu_title">카드</a>
                <div class="mega-panel">
                    <div class="mega-inner">
                        <div class="mega-col">
                            <h4>카드신청</h4>
                            <ul>
                                <li><a th:href="@{/card/list}">체크카드</a></li>
                                <li><a th:href="@{/card/list}">신용카드</a></li>
                                <li><a th:href="@{/card/list}">기업카드</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </li>

            <li>
                <a href="/" class="menu_title">고객지원</a>
                <div class="mega-panel">
                    <div class="mega-inner">
                        <div class="mega-col">
                            <h4>인증 센터</h4>
                            <ul>
                                <li><a href="#">카드본인확인서비스</a></li>
                            </ul>
                        </div>
                        <div class="mega-col">
                            <h4>기타 안내</h4>
                            <ul>
                                <li><a href="#">카드 종합 이용 안내</a></li>
                                <li><a href="#">고객 이용 약관 안내</a></li>
                                <li><a href="#">웹사이트 이용 안내</a></li>
                                <li><a href="#">상품공시실 / 자료실</a></li>
                                <li><a href="#">뉴스 / 공지</a></li>
                            </ul>
                        </div>
                        <div class="mega-col">
                            <h4>상담</h4>
                            <ul>
                                <li><a th:href="@{cs/ai/cs}">AI 상담</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </li>
        </ul>
        <div class="util">
            <form th:action="@{/card/list}" method="get">
                <div class="search-box">
                    <input type="text"
                           name="keyword"
                           th:value="${keyword}"
                           placeholder="검색어를 입력해 주세요.">
                    <button type="submit" class="search-ico" aria-label="검색">
                        <img th:src="@{/images/search.png}">
                    </button>
                </div>
            </form>
            <!-- ▼ 예전 디자인 그대로 세션바 옮겨오기 ▼ -->
            <section class="myp-session-bar" th:if="${loginUser != null}">
                <div class="myp-session-left">
                    <!-- 실제 로그인 사용자 이름 바인딩 -->
                    <button type="button" class="link-name" id="btnUserInfo">
                        <a th:href="@{/my/Profile}">
                            <span th:text="${loginUser.name} + '님'">홍길동님</span>
                        </a>
                    </button>
                </div>
                <div class="myp-session-right">
                    <button type="button" class="btn-session-extend" id="btnExtend">
                        로그인 연장
                    </button>
                    <span class="session-timer" id="sessionTimer">
                        09:58
                    </span>
                </div>
            </section>
        </div>
    </div>
</header>

<script>
    // 스크롤 시 헤더 그림자
    window.addEventListener('scroll', () => {
        const header = document.querySelector('.header');
        if (window.scrollY > 10) {
            header.classList.add('scrolled');
        } else {
            header.classList.remove('scrolled');
        }
    });

    // ===== 로그인 세션 타이머 (공통) =====
    (function () {
        const timerEl = document.getElementById('sessionTimer');
        const btnExtend = document.getElementById('btnExtend');
        const btnUserInfo = document.getElementById('btnUserInfo');

        // 세션바가 없는 페이지(비로그인 등)는 스킵
        if (!timerEl || !btnExtend) return;

        const DEFAULT_SECONDS = 10 * 60; // 10분 예시
        let remain = DEFAULT_SECONDS;
        let timerId = null;

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
        }

        function updateView() {
            timerEl.textContent = formatTime(remain);
        }

        function startTimer() {
            if (timerId) clearInterval(timerId);
            timerId = setInterval(() => {
                remain--;
                if (remain <= 0) {
                    clearInterval(timerId);
                    timerId = null;
                    remain = 0;
                    updateView();
                    alert('로그인 시간이 만료되었습니다. 다시 로그인해 주세요.');
                    // location.href = '/login'; // 필요하면 활성화
                    return;
                }
                updateView();
            }, 1000);
        }

        // 로그인 연장 버튼
        btnExtend.addEventListener('click', () => {
            // TODO: 실제 세션 연장 API 호출
            // fetch('/api/session/extend', { method: 'POST' });

            remain = DEFAULT_SECONDS;
            updateView();
            if (!timerId) startTimer();

            // 데모용
            // alert('로그인 시간이 연장되었습니다.');
        });

        // 이름 클릭 시 마이페이지로 이동
        if (btnUserInfo) {
            btnUserInfo.addEventListener('click', () => {
                window.location.href = '/member/my'; // 실제 마이페이지 경로로 수정
            });
        }

        // 초기 시작
        updateView();
        startTimer();
    })();
</script>